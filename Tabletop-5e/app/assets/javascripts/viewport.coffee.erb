$ ->
  viewport = $('#viewport canvas').get(0)
  if (viewport)
    Viewport.initializeViewport()
    $(window).load -> Viewport.drawMap()
    Viewport.drawMap()
    Viewport.resizeCanvas()

class @Viewport
  @open_high
  @open_med
  @open_low
  @normal_high
  @normal_med
  @normal_low
  @difficult_high
  @difficult_med
  @difficult_low
  @blocked_high
  @blocked_med
  @blocked_low
  @token_high
  @token_med
  @token_low
  
  # Canvas context
  @ctx
  
  # Pre-render canvas
  @pre_ctx
  
  @zoom = 50
  
  @initializeViewport: ->
    @loadImages()
    @loadEventHandlers()
    @ctx = $('#viewport canvas').get(0).getContext('2d')
    pre_canvas = document.createElement('canvas')
    @pre_ctx = pre_canvas.getContext('2d')
    @pre_ctx.canvas.width = (gon.map.width) * @zoom
    @pre_ctx.canvas.height = (gon.map.length) * @zoom
    
  @loadImages: ->
    @open_high = new Image()
    @open_med = new Image()
    @open_low = new Image()
    @normal_high = new Image()
    @normal_med = new Image()
    @normal_low = new Image()
    @difficult_high = new Image()
    @difficult_med = new Image()
    @difficult_low = new Image()
    @blocked_high = new Image()
    @blocked_med = new Image()
    @blocked_low = new Image()
    @token_high = new Image()
    @token_med = new Image()
    @token_low = new Image()
    @open_high.src = "<%= asset_path('open_high_rez.jpg') %>"
    @open_med.src = "<%= asset_path('open_med_rez.jpg') %>"
    @open_low.src = "<%= asset_path('open_low_rez.jpg') %>"
    @normal_high.src = "<%= asset_path('normal_high_rez.jpg') %>"
    @normal_med.src = "<%= asset_path('normal_med_rez.jpg') %>"
    @normal_low.src = "<%= asset_path('normal_low_rez.jpg') %>"
    @difficult_high.src = "<%= asset_path('difficult_high_rez.jpg') %>"
    @difficult_med.src = "<%= asset_path('difficult_med_rez.jpg') %>"
    @difficult_low.src = "<%= asset_path('difficult_low_rez.jpg') %>"
    @blocked_high.src = "<%= asset_path('blocked_high_rez.jpg') %>"
    @blocked_med.src = "<%= asset_path('blocked_med_rez.jpg') %>"
    @blocked_low.src = "<%= asset_path('blocked_low_rez.jpg') %>"
    @token_high.src = "<%= asset_path('token_high_rez.jpg') %>"
    @token_med.src = "<%= asset_path('token_med_rez.jpg') %>"
    @token_low.src = "<%= asset_path('token_low_rez.jpg') %>"
    
  @loadEventHandlers: ->
    viewport = $('#viewport canvas')
    viewport.on 'click', @clickHandler
#    $(window).on 'resize', @resizeCanvas
    
  # Pre-render
  @drawMap: -> 
    switch
      when @zoom < 25 
        open_tile = @open_low
        normal_tile = @normal_low
        difficult_tile = @difficult_low
        blocked_tile = @blocked_low
        token = @token_low
        inputSize = 10
      when @zoom < 75
        open_tile = @open_med
        normal_tile = @normal_med
        difficult_tile = @difficult_med
        blocked_tile = @blocked_med
        token = @token_med
        inputSize = 50
      else
        open_tile = @open_high
        normal_tile = @normal_high
        difficult_tile = @difficult_high
        blocked_tile = @blocked_high
        token = @token_high
        inputSize = 100
        
    for i in [0..gon.map.length - 1]
      for j in [0..gon.map.width - 1]
        switch gon.map.tiles[i][j].terrain
          when 'open'
            @pre_ctx.drawImage(open_tile, 0, 0, inputSize, inputSize, j * @zoom, i * @zoom, @zoom, @zoom)
          when 'normal'
            @pre_ctx.drawImage(normal_tile, 0, 0, inputSize, inputSize, j * @zoom, i * @zoom, @zoom, @zoom)
          when 'difficult'
            @pre_ctx.drawImage(difficult_tile, 0, 0, inputSize, inputSize, j * @zoom, i * @zoom, @zoom, @zoom)
          when 'blocked'
            @pre_ctx.drawImage(blocked_tile, 0, 0, inputSize, inputSize, j * @zoom, i * @zoom, @zoom, @zoom)
        if gon.map.tiles[i][j].token
          @pre_ctx.drawImage(@token, 0, 0, inputSize, inputSize, j * @zoom, i * @zoom, @zoom, @zoom)
    
    @render()
    
  @render: ->
    @ctx.drawImage(@pre_ctx.canvas, 0, 0, @ctx.canvas.width, @ctx.canvas.height, 0, 0, @ctx.canvas.width, @ctx.canvas.height)
    
  
  # Event handlers
  
  @clickHandler: (e) ->
    offsetLeft = e.target.offsetLeft - $(document).scrollLeft()
    offsetTop = e.target.offsetTop - $(document).scrollTop()
    x = e.clientX - offsetLeft
    y = e.clientY - offsetTop
    zoom = Viewport.zoom
    alert 'Coordinates: ' + (x // zoom) + ', ' + (y // zoom)
    
  @resizeCanvas: (e) ->
    w = document.body.offsetWidth
    h = document.body.offsetHeight
    Viewport.ctx.canvas.width = w
    Viewport.ctx.canvas.height = h
    margin = $('.viewportPanel').css('width')
    $('#viewport canvas').css("marginLeft", margin)
    Viewport.render()
    
  @draw: (e) ->
    alert "draw"
    @drawImage
    
  @zoomIn: (e) ->
    @zoom += 10
    @drawImage
    
  @zoomOut: (e) ->
    @zoom -= 10
    @drawImage
  
  
  #  ctx.drawImage( image, 
  #                20, 20,     # Start at 20/20 pixels from the left and the top of the image (crop),
  #                1000, 800,  # "Get" a `1000 * 800` (w * h) area from the source image (crop),
  #                0, 0,       # Place the result at 0, 0 in the canvas,
  #                1000, 800); # With as width / height: 1000 * 800 (scale) 